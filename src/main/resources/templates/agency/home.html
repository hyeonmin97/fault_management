<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title>대리점 홈</title>
    <!-- Latest compiled and minified CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.2.3/dist/css/bootstrap.min.css" rel="stylesheet">

    <!-- Latest compiled JavaScript -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.2.3/dist/js/bootstrap.bundle.min.js"></script>

    <!--  naver map  -->
    <script type="text/javascript" src="https://openapi.map.naver.com/openapi/v3/maps.js?ncpClientId=vj84p96otr"></script>

    <!--  chart.js  -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <style>
        .note{
            width: 200px;
            max-width: 200px;
        }
        tr, td {
            text-align: center;
        }
    </style>

</head>
<body>
<!--전체 컨테이너-->
<div class="container min-vw-100 w-100" th:object="${agencyHome}">
    <!--  대리점명 -->
    <div style="text-align: center" class="container my-5 w-100">
        <span class="fs-1" th:text="*{getName()}">대리점명</span>
    </div>

    <!--  대기중인 장애내역  -->
    <div style="min-width: 800px;" class="container mt-5 w-100">
        <span class="fs-4">대기중인 장애내역</span>
        <table class="table fs-6 align-middle mt-3">
            <thead>
            <tr>
                <th>id</th>
                <th>접수일</th>
                <th>처리방법</th>
                <th>처리상태</th>
                <th>장애타입</th>
                <th>고객이름</th>
                <th>고객전화번호</th>
                <th>특이사항</th>
                <th>엔지니어 할당</th>
                <!--                <th>정기점검 여부</th>-->
            </tr>
            </thead>
            <tbody>
            <tr th:each="incident : *{getWaitingIncidentList()}">
                <td th:text="${incident.getIncidentId()}">id</td>
                <td th:text="${#temporals.format(incident.getCreateDate(), 'yyyy-MM-dd HH:mm')}">접수일</td>
                <td th:text="${incident.getProcessMethod().getValue()}">처리방법</td>
                <td th:text="${incident.getProcessStatus().getValue()}">처리상태</td>
                <td th:text="${incident.getIncidentType().getLarge() + ' / ' + incident.getIncidentType().getMedium() + ' / ' + incident.getIncidentType().getSmall()}">장애타입</td>
                <td th:text="${incident.getCustomerName()}">고객이름</td>
                <td th:text="${incident.getCustomerPhone()}">고객전화번호</td>
                <td class="note text-break" th:text="${incident.getText()}">특이사항특이사항특이사항특이사항특이사항특이사항특이사항특이사항특이사항특이사항특이사항특이사항 특이사항특이사항</td>
                <!--                    <td th:text="${incident.get}">정기점검 여부</td>-->
                <td><a><button type="button" class="btn btn-primary " data-bs-toggle="modal" data-bs-target="#engineerModal" th:attr="data-bs-id=${incident.getIncidentId()}">엔지니어 할당</button></a></td>
            </tr>
            </tbody>
        </table>
    </div>

    <!-- Modal -->
    <th:block th:replace="~{/modal/engineerAssignment :: engineerAssignment(*{getEngineerInfoDtoList()})}"></th:block>

    <script>
        //modal창에 선택한 장애의 id를 전달
        const engineerInput = document.getElementById('engineerId')
        const engineerModal = document.getElementById('engineerModal')
        const incidentInput = document.getElementById('incidentId')
        const engineerButtons = document.getElementsByClassName("selectButton")

        //모달창 꺼지면 값 초기화
        engineerModal.addEventListener('hide.bs.modal', event=>{
            //버튼 색 초기화
            for (let i = 0; i < engineerButtons.length; i++) {
                engineerButtons[i].classList.remove("btn-primary")
                engineerButtons[i].classList.add("btn-secondary")
            }

            //모달의 form에 있는 hidden input 값 초기화
            engineerInput.value = "";
            incidentInput.value = "";
        })

        //모달창 켜지면 값 설정
        engineerModal.addEventListener('show.bs.modal', event => {
            //클릭한 장애 버튼 저장
            const button = event.relatedTarget

            //버튼에 있는 장애 아이디 값 저장
            const incidentId = button.getAttribute('data-bs-id')

            //모달창의 incidentId에 값 저장
            incidentInput.value = incidentId;
        })
    </script>



    <div style="min-width: 800px;" class="container mt-5 w-100">
        <span class="fs-4">진행중인 장애목록</span>
        <table class="table fs-6  align-middle mt-3">
            <thead>
            <tr>
                <th>id</th>
                <th>접수일</th>
                <th>처리방법</th>
                <th>처리상태</th>
                <th>장애타입</th>
                <th>고객이름</th>
                <th>고객전화번호</th>
                <th>특이사항</th>
                <th>엔지니어 아이디</th>
                <th>엔지니어 이름</th>
                <!--                <th>정기점검 여부</th>-->
            </tr>
            </thead>
            <tbody>
            <tr th:each="incident : *{getWorkingIncidentList()}">
                <td th:text="${incident.getIncidentId()}">id</td>
                <td th:text="${#temporals.format(incident.getCreateDate(), 'yyyy-MM-dd HH:mm')}">접수일</td>
                <td th:text="${incident.getProcessMethod().getValue()}">처리방법</td>
                <td th:text="${incident.getProcessStatus().getValue()}">처리상태</td>
                <td th:text="${incident.getIncidentType().getLarge() + ' / ' + incident.getIncidentType().getMedium() + ' / ' + incident.getIncidentType().getSmall()}">장애타입</td>
                <td th:text="${incident.getCustomerName()}">고객이름</td>
                <td th:text="${incident.getCustomerPhone()}">고객전화번호</td>
                <td class="note text-break"  th:text="${incident.getText()}">특이사항</td>
                <td th:text="${incident.getEngineerId()}">엔지니어 아이디</td>
                <td th:text="${incident.getEngineerName()}">엔지니어 이름</td>
                <!--                    <td th:text="${incident.get}">정기점검 여부</td>-->
            </tr>
            </tbody>

        </table>
    </div>

    <!--완료된 장애목록-->
    <div style="min-width: 800px;" class="container mt-5 w-100">
        <span class="fs-4">완료된 장애목록</span>
        <a class="link-info fs-6 ms-3" href="#" th:href="|${agencyCode}/incident|"><span>더보기</span></a>
        <table class="table fs-6  align-middle mt-3">
            <thead>
            <tr>
                <th>id</th>
                <th>접수일</th>
                <th>완료일</th>
                <th>처리방법</th>
                <th>장애타입</th>
                <th>고객이름</th>
                <th>고객전화번호</th>
                <th>특이사항</th>
                <th>엔지니어 아이디</th>
                <th>엔지니어 이름</th>
                <!--                <th>정기점검 여부</th>-->
            </tr>
            </thead>
            <tbody>
            <tr th:each="incident : *{(getRecentlyCompletedIncidentList())}">
                <td th:text="${incident.getIncidentId()}">id</td>
                <td th:text="${#temporals.format(incident.getCreateDate(), 'yyyy-MM-dd HH:mm')}">접수일</td>
                <td th:text="${#temporals.format(incident.getCreateDate(), 'yyyy-MM-dd HH:mm')}">완료일</td>
                <td th:text="${incident.getProcessMethod().getValue()}">처리방법</td>
                <td th:text="${incident.getIncidentType().getLarge() + ' / ' + incident.getIncidentType().getMedium() + ' / ' + incident.getIncidentType().getSmall()}">장애타입</td>
                <td th:text="${incident.getCustomerName()}">고객이름</td>
                <td th:text="${incident.getCustomerPhone()}">고객전화번호</td>
                <td class="note text-break"  th:text="${incident.getText()}">특이사항</td>
                <td th:text="${incident.getEngineerId()}">엔지니어 아이디</td>
                <td th:text="${incident.getEngineerName()}">엔지니어 이름</td>
                <!--                    <td th:text="${incident.get}">정기점검 여부</td>-->
            </tr>
            </tbody>

        </table>
    </div>

    <!--  인원 현황  -->
    <div class="container mt-5 w-100">
        <span class="fs-4">인원 현황</span>
    </div>
    <!-- 차트 -->
    <div class="container d-flex min-vw-75 justify-content-center align-items-center">
        <div class="min-vw-25" >
            <canvas id="engineerChart"></canvas>
        </div>
        <div class="min-vw-25" >
            <canvas id="resignationCountChart"></canvas>
        </div>
        <div class="min-vw-25" >
            <canvas id="joinCountChart"></canvas>
        </div>
    </div>

    <!--    엔지니어 리스트-->
    <div style="min-width: 800px;" class="container mt-5 w-100">
        <span class="fs-4">소속 엔지니어</span>
        <table class="table fs-6 align-middle mt-3">
            <thead>
            <tr>
                <th>id</th>
                <th>이름</th>
                <th>나이</th>
                <th>전화번호</th>
                <th>입사일</th>
                <th>퇴사일</th>
                <th>상태</th>
            </tr>
            </thead>
            <tbody>
                <tr th:each="engineer : *{getEngineerInfoDtoList()}">
                    <td><a th:href="|../engineer/${engineer.getId()}|" href="#" class="link-info"> <span th:text="${engineer.getId()}">id</span></a></td>
                    <td th:text="${engineer.getName()}">이름</td>
                    <td th:text="${engineer.getAge()}">나이</td>
                    <td th:text="${engineer.getPhone()}">전화번호</td>
                    <td th:text="${#temporals.format(engineer.getJoinDate(), 'yyyy-MM-dd HH:mm')}">입사일</td>
                    <td th:text="${#temporals.format(engineer.getResignationDate(), 'yyyy-MM-dd HH:mm')}">퇴사일</td>
                    <td th:text="${engineer.getEngineerStatus()}">상태</td>
                </tr>
            </tbody>

        </table>
    </div>

    <!--  관리 점포  -->
    <div class="container mt-5 w-100">
        <span class="fs-4">점포 분포</span>
    </div>
    <div class="d-flex justify-content-center min-vw-75">
        <div id="map" style="min-width:800px;width:75%;height:500px;"></div>
    </div>

    <!--  관리 점포 목록  -->
    <div style="min-width: 800px;" class="container mt-5 w-100 ">
        <span class="fs-4">점포 목록</span>
        <table class="table fs-6 align-middle mt-3">
            <thead>
                <tr>
                    <th>점포코드</th>
                    <th>점포명</th>
                    <th>점포전화번호</th>
                    <th>팩스번호</th>
                    <th>매니저 이름</th>
                    <th>매니저 전화번호</th>
                    <th>주소</th>
                    <th>오픈일</th>
                    <th>폐점일</th>
                    <th>최근 점검일</th>
                    <th>다음 점검일</th>
                    <th>점포 타입</th>
                    <th>점포 상태</th>
                </tr>
            </thead>
            <tbody>
                <tr style="font-size: 12px" th:each="store : *{getStoreCoordinateList()}">
                    <td ><a th:href="|../store/${store.getStoreCode()}|" href="#" class="link-info"> <span th:text="${store.getStoreCode()}">점포코드</span></a></td>
                    <td th:text="${store.getName()}">점포명</td>
                    <td th:text="${store.getTelephone()}">점포 전화번호</td>
                    <td th:text="${store.getFax()}">팩스 번호</td>
                    <td th:text="${store.getManagerName()}">매니저 이름</td>
                    <td th:text="${store.getManagerPhone()}">매니저 전화번호</td>
                    <td th:utext="${'(' + store.getPostalCode() + ')<br>' + store.getAddress() +'<br>' + store.getAddressDetail() }">(01678)서울시 노원구 한글비석로 <br> 107동 612호</td>
                    <td th:text="${#temporals.format(store.getOpenDate(), 'yyyy-MM-dd HH:mm')}">오픈일</td>
                    <td th:text="${#temporals.format(store.getCloseDate(), 'yyyy-MM-dd HH:mm')}">폐점일</td>
                    <td th:text="${#temporals.format(store.getInspectionDateLast(), 'yyyy-MM-dd HH:mm')}">최근 점검일</td>
                    <td th:text="${#temporals.format(store.getInspectionDateNext(), 'yyyy-MM-dd HH:mm')}">다음 점검일</td>
                    <td th:text="${store.getStoreType().getValue()}">점포 타입</td>
                    <td th:text="${store.getStoreAgencyStatus().getValue()}">점포 상태</td>
                </tr>
            </tbody>
        </table>
    </div>
</div>

<!-- 엔지니어 선택 관련 스크립트 -->
<script>
    <!--선택한 엔지니어의 값을 저장, 표시하는 함수-->
    function engineerClick(clickedId) {
        var engineerButtons = document.getElementsByClassName("selectButton")
        var engineerInput = document.getElementById("engineerId")
        console.log(" engineerClick  :  ",clickedId)
        for (var i=0; i< engineerButtons.length; i++) {
            if (engineerButtons[i].id == clickedId) {
                engineerButtons[i].classList.add("btn-primary")
                engineerButtons[i].classList.remove("btn-secondary")
            }else{
                engineerButtons[i].classList.add("btn-secondary")
                engineerButtons[i].classList.remove("btn-primary")
            }
        }
        engineerInput.value = clickedId;
    }
</script>
<script th:inline="javascript">
    /*<![CDATA[*/
    var agencyDto = [[${agencyHome}]];
    /*]]>*/
</script>
<script src="/js/agencyHome.js" th:inline="javascript"></script>
</body>
</html>