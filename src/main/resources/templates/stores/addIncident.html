<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title>점포 상세정보</title>
    <!-- Latest compiled and minified CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.2.3/dist/css/bootstrap.min.css" rel="stylesheet">

    <!-- Latest compiled JavaScript -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.2.3/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>

    <script th:inline="javascript">

        function agencyClick(name, code, clickedId) {
            console.log(" agency Click :  ",name, code, clickedId)
            var agencyButtons = document.getElementsByClassName("agencyButton")
            for (var i=0; i< agencyButtons.length; i++) {
                if (agencyButtons[i].id == clickedId) {
                    agencyButtons[i].classList.add("btn-primary")
                    agencyButtons[i].classList.remove("btn-secondary")
                }else{
                    agencyButtons[i].classList.add("btn-secondary")
                    agencyButtons[i].classList.remove("btn-primary")
                }
            }
            $('#agencyCode').attr('value', code);
            $('#agencyName').text(name);

        }
        function submitCheck() {
            //장애유형, 대리점 선택 여부 확인
            //smallType,agencyCode
            var smallType = document.getElementById("smallType")
            var agencyCode = document.getElementById("agencyCode")

            var selectedIncidentType = smallType.value
            var selectedAgency = agencyCode.value

            console.log("selectedIncidentType : ", selectedIncidentType)
            console.log("selectedAgency : ", selectedAgency)

            //selectedAgency가 truthy 값인지 체크
            if(selectedIncidentType != -1 && selectedAgency)
                return true;
            alert("모든 값을 입력해주세요")
            return false;

        }

        $(function(){
            areaSelectMaker("#largeType", "#mediumType", "#smallType");
        });

        var areaSelectMaker = function(a1, a2, a3){
            if(a1 == null || a2 == null || a3 == null){
                console.warn("Unkwon Area Tag");
                return;
            }

            var type = [[${incidentType}]];
            console.log(type);
            //초기화
            init(true, true);

            //권역 기본 생성
            var largeType = Object.keys(type);
            largeType.forEach(function(large){
                $(a1).append("<option value="+large+">"+large+"</option>");
            });

            //변경 이벤트
            $(document).on("change", a1, function(){
                init(false, true);
                var large = $(this).val();
                var keys = Object.keys(type[large]);
                keys.forEach(function(medium){
                    $(a2).append("<option value="+medium+">"+medium+"</option>");
                });
            }).on("change", a2, function(){
                init();
                var large = $(a1).val();
                var medium = $(this).val();
                var keys = Object.keys(type[large][medium]);
                keys.forEach(function(small){
                    $(a3).append("<option value="+type[large][medium][small].id+">"+type[large][medium][small].name+"</option>");
                });
            });

            function init(first, second){
                first ? $(a1).empty().append("<option value='-1'>선택</option>") : "";
                second ? $(a2).empty().append("<option value='-1'>선택</option>") : "";
                $(a3).empty().append("<option value='-1'>선택</option>");
            }
        }


    </script>
</head>
<body>
<h1>incidentTypeList</h1>
<span th:text="${incidentType}"></span>

<h1>incidentRequestDto</h1>
<span th:text="${incidentRequestDto}"></span>

<hr>

<!--전체 컨테이너-->
    <div class="container">

        <!-- 점포 정보 출력 -->
        <div class="container  w-75">
            <table class="table table-borderless">
                <tbody class="text-center">
                    <tr>
                        <td>
                            <h2 th:text="${incidentRequestDto.getStoreName()}">점포 이름</h2>
                        </td>
                        <td rowspan="2">
                            <img src="https://naveropenapi.apigw.ntruss.com/map-static/v2/raster-cors?w=300&h=300&center=127.1054221,37.3591614&level=16&X-NCP-APIGW-API-KEY-ID=vj84p96otr"
                                th:src="'https://naveropenapi.apigw.ntruss.com/map-static/v2/raster-cors?w=300&h=300&format=png&X-NCP-APIGW-API-KEY-ID=vj84p96otr&markers=type:d|size:mid|pos:' + |${incidentRequestDto.getPoint().getX()} ${incidentRequestDto.getPoint().getY()}|"
                                 class="img-thumbnail text-end">
                        </td>
                    </tr>
                    <tr>
                        <td>
                            <table class="table table-bordered">
                                <tbody>
                                    <tr>
                                        <th scope="row">사장님 이름</th>
                                        <td th:text="${incidentRequestDto.getManagerName()}">홍길동</td>
                                    </tr>
                                    <tr>
                                        <th scope="row">사장님 전화번호</th>
                                        <td th:text="${incidentRequestDto.getManagerPhone()}">010</td>
                                    </tr>
                                    <tr>
                                        <th scope="row">주소</th>
                                        <td th:text="${incidentRequestDto.getStoreAddress()}">주소</td>
                                    </tr>
                                    <tr>
                                        <th scope="row">상세주소</th>
                                        <td th:text="${incidentRequestDto.getStoreAddressDetail()}">상세주소</td>
                                    </tr>
                                </tbody>
                            </table>
                        </td>
                    </tr>
                </tbody>
            </table>
        </div>

        <!--장애 정보 추가 폼-->
        <div class="container w-75 bg-dark bg-opacity-10 p-5">
            <form th:action="|/stores/${incidentRequestDto.getStoreCode()}/incident|" method="post" onsubmit="return submitCheck()">
                <!--전화한 고객 이름-->
                <div class="w-50">
                    <span class="fs-4 mb-2 d-block">고객 이름</span>
                    <input class="form-control" name="customerName" type="text">
                </div>

                <!--전화한 고객 전화번호-->
                <div class="d-block my-5 w-50">
                    <span class="fs-4 mb-2 d-block">고객 전화번호</span>
                    <input class="form-control" name="customerPhone" type="tel">
                </div>

                <!--장애유형-->
                <span class="d-block fs-4">장애 유형</span>
                <div>
                    <select class="form-select w-25 d-inline p-2 " id="largeType"></select>
                    <select class="form-select w-25 d-inline p-2 " id="mediumType"></select>
                    <select class="form-select w-25 d-inline p-2 " id="smallType" name="incidentType"></select>
                </div>

                <!--특이사항-->
                <div class="form-floating my-5">
                    <span class="fs-4 mb-2 d-block">특이사항</span>
                    <textarea class="form-control w-50" placeholder="특이사항" id="floatingTextarea" name="text" style="height: 100px"></textarea>
                </div>

                <!--처리방법-->
                <div class="my-5">
                    <span class="fs-4 d-block mb-2">처리 방법</span>
                    <div class="form-check form-check-inline">
                        <div class="d-flex align-items-center">
                            <input class="form-check-input me-2" type="radio" name="processMethod" id="processMethod1" value="CALL" checked>
                            <label class="form-check-label fs-5" for="processMethod1">유선 처리</label>
                        </div>
                    </div>
                    <div class="form-check form-check-inline">
                        <div class="d-flex align-items-center">
                            <input class="form-check-input me-2" type="radio" name="processMethod" id="processMethod2" value="VISIT">
                            <label class="form-check-label fs-5" for="processMethod2">방문 처리</label>
                        </div>
                    </div>
                </div>

                <!--주변 대리점 리스트-->
                <div>
                    <span class="fs-4 d-block mb-2">대리점 선택</span>
                    <table class="table">
                        <thead>
                            <tr>
                                <td>대리점명</td>
                                <td>점포와의 거리</td>
                                <td>가용 엔지니어</td>
                                <td>선택</td>
                            </tr>
                        </thead>
                        <tbody>
                            <tr th:each="agency : ${incidentRequestDto.getAgencyAndStoreDistanceDtoList()}">
                                <td th:text="${agency.getName()}">점포 이름</td>
                                <td th:text="${#numbers.formatDecimal(agency.getDistance()/1000, 1, 2)}+ ' KM'">0 KM</td>
                                <td th:text="|${agency.getWorkCount()} / ${agency.getTotalCount()}|">0/0</td>
                                <td>
                                    <button th:if="${agency.getWorkCount()==0}" type="button" class="btn btn-secondary disabled" value="agencyCode" >대리점 선택</button>
                                    <button th:unless="${agency.getWorkCount()==0}" th:id="'agencyButton'+${agencyStat.index}" type="button" class="btn agencyButton btn-secondary" th:onclick="agencyClick([[${agency.getName()}]], [[${agency.getAgencyCode()}]], this.id)" value="agencyCode" th:value="${agency.getAgencyCode()} ">대리점 선택</button>
                                </td>
                            </tr>
                        </tbody>

                    </table>
                    <span class="fs-4" id="agencyName">대리점명</span>

                </div>
                <input type="hidden" name="agencyCode" id="agencyCode" value="">
                <button type="submit" class="btn btn-primary">추가</button>
            </form>

        </div>
    </div>

</body>
</html>